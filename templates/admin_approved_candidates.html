<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approved Candidates - Swizosoft</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-y: scroll; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; padding-top: 70px; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem 0; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
        .navbar-container { max-width: 100%; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; width: 100%; }
        .navbar-brand { display: flex; align-items: center; gap: 1rem; color: white; font-size: 1.5rem; font-weight: 700; flex-shrink: 0; }
        .navbar-menu { display: flex; gap: 1.5rem; align-items: center; margin-left: auto; flex-wrap: nowrap; justify-content: flex-end; }
        .nav-link { color: rgba(255,255,255,0.8); text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; transition: all 0.3s; white-space: nowrap; }
        .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-link.active { color: white; background: rgba(255,255,255,0.2); }
        .logout-link { background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .page-header { margin-bottom: 2rem; }
        .page-header h2 { font-size: 2rem; margin-bottom: 0.5rem; }
        .page-header p { color: #666; }
        .section-header { margin-bottom: 1.5rem; }
        .section-header h3 { font-size: 1.3rem; margin-bottom: 0.5rem; }
        .count-badge { background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .empty-state { text-align: center; padding: 3rem 2rem; color: #999; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .candidates-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); table-layout: fixed; }
        .candidates-table th, .candidates-table td { padding: 0.9rem; border-bottom: 1px solid #eee; text-align: left; font-size: 0.95rem; white-space: normal; word-break: break-word; }
        .candidates-table thead th { background: #f8f9fa; font-weight: 700; color: #333; }
        .candidates-table tbody tr:hover { background: #f9fafb; }
        .file-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .file-btn { background: #667eea; color: white; border: none; padding: 0.4rem 0.7rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: background 0.3s; white-space: nowrap; }
        .file-btn:hover { background: #764ba2; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); width: 95vw; height: 95vh; display: flex; flex-direction: column; border-radius: 8px; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h3 { margin: 0; font-size: 1.2rem; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 40px; height: 40px; border-radius: 4px; transition: background 0.3s; flex-shrink: 0; }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 2rem; overflow-y: auto; flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; }
        .file-preview-img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; }
        .file-preview-text { background: #f5f5f5; padding: 1.5rem; border-radius: 4px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-word; width: 100%; }
        @media (max-width: 768px) {
            .navbar-menu { gap: 1rem; }
            .nav-link { padding: 0.4rem 0.6rem; font-size: 0.85rem; }
            .container { padding: 1rem; }
            .candidates-table th, .candidates-table td { padding: 0.5rem; font-size: 0.85rem; }
            .file-btn { padding: 0.3rem 0.6rem; font-size: 0.7rem; }
        }

        /* Full-bleed file viewer for large screens */
        #fileModal .modal-content.full-bleed { width: 100vw !important; height: 100vh !important; border-radius: 0 !important; max-width: none !important; }
        #fileModal .modal-header.full-bleed-header { padding: 1rem 1.25rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì Swizosoft</div>
            <div class="navbar-menu">
                <a href="{{ url_for('admin_dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('admin_selected') }}" class="nav-link">Selected Candidates</a>
                <a href="{{ url_for('admin_approved_candidates') }}" class="nav-link active">Approved Candidates</a>
                <a href="{{ url_for('admin_job_description') }}" class="nav-link">Job Description</a>
                <a href="{{ url_for('admin_logout') }}" class="nav-link logout-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>Approved Candidates</h2>
            <p>List of all approved candidates with their complete information and documents</p>
        </div>

        <div class="section-header">
            <h3>Free Internship Approved Candidates <span class="count-badge" id="approved-count">0</span></h3>
        </div>

        <div id="approvedCandidatesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <p>Loading approved candidates...</p>
            </div>
        </div>
    </div>

    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="fileTitle">File Viewer</h3>
                <button class="modal-close" onclick="closeFileModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="fileViewerContainer"></div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="profileTitle">Candidate Profile</h3>
                <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="profileBody" style="width:100%;max-width:1100px"></div>
            </div>
        </div>
    </div>

    <script>
        function escapeHtml(t) { return String(t || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
        
        function formatDate(d) {
            if (!d) return '-';
            try { return String(new Date(d).toLocaleDateString('en-IN', {year:'numeric',month:'short',day:'numeric'})); }
            catch { return String(d); }
        }
        
        function viewFile(fname, b64, type) {
            const m = document.getElementById('fileModal');
            const c = document.getElementById('fileViewerContainer');
            document.getElementById('fileTitle').textContent = 'View: ' + escapeHtml(fname);
            // make modal full-bleed on open for a laptop-like viewer
            try { m.querySelector('.modal-content').classList.add('full-bleed'); } catch(e){}
            try { m.querySelector('.modal-header').classList.add('full-bleed-header'); } catch(e){}
            try {
                const ext = fname.split('.').pop().toLowerCase();
                // Make embedded viewer wider for laptop screens by using viewport-relative widths
                if (['jpg','jpeg','png','gif','bmp','webp'].includes(ext)) {
                    c.innerHTML = `<div style="display:flex;justify-content:center;width:100%"><img src="data:image/;base64,${b64}" class="file-preview-img" alt="${escapeHtml(fname)}" style="max-width:100vw;max-height:calc(100vh - 72px);border-radius:0;"></div>`;
                } else if (ext === 'pdf') {
                    // Full-bleed iframe for laptop screens
                    c.innerHTML = `<div style="width:100%;height:100%"><iframe src="data:application/pdf;base64,${b64}" style="width:100vw;height:calc(100vh - 72px);border:none;"></iframe></div>`;
                } else {
                    try {
                        const t = new TextDecoder('utf-8').decode(new Uint8Array(atob(b64).split('').map(x => x.charCodeAt(0))));
                        c.innerHTML = `<div style="display:flex;justify-content:center;width:100%"><pre class="file-preview-text" style="max-width:100vw">${escapeHtml(t.substring(0,10000))}</pre></div>`;
                    } catch { c.innerHTML = '<div class="file-preview-text">Binary file - cannot preview</div>'; }
                }
            } catch (e) { c.innerHTML = `<div class="file-preview-text">Error: ${escapeHtml(e.message)}</div>`; }
            m.classList.add('show');
        }
        
        function downloadFile(fname, b64) {
            try {
                const l = document.createElement('a');
                l.href = `data:application/octet-stream;base64,${b64}`;
                l.download = fname;
                document.body.appendChild(l);
                l.click();
                document.body.removeChild(l);
            } catch (e) { alert('Error: ' + e.message); }
        }
        
        function closeFileModal() { document.getElementById('fileModal').classList.remove('show'); }
        
        window.onclick = (e) => { 
            if (e.target === document.getElementById('fileModal')) closeFileModal(); 
            if (e.target === document.getElementById('profileModal')) closeProfileModal(); 
        };
        
        async function loadApprovedCandidates() {
            console.log('üì° Starting load...');
            try {
                const r = await fetch('/admin/api/get-approved-candidates');
                console.log('‚úÖ Fetch response:', r.status);
                const ct = (r.headers.get('content-type') || '').toLowerCase();
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                if (!ct.includes('application/json')) throw new Error('Non-JSON response');
                const data = await r.json();
                console.log('‚úÖ Data received:', data.data?.length, 'rows');
                const cnt = document.getElementById('approvedCandidatesContainer');
                
                if (data.success && data.data && data.data.length > 0) {
                    console.log('üìä Building compact table...');
                    // Only show the requested columns: Name, USN, View Profile, View Resume, View ID, View Project, Accept, Reject
                    let html = '<table class="candidates-table"><thead><tr><th>Name</th><th>USN</th><th>Profile</th><th>Resume</th><th>ID</th><th>Project</th><th>Actions</th></tr></thead><tbody>';
                    data.data.forEach((c, idx) => {
                        html += `<tr>`;
                        html += `<td>${escapeHtml(c.name||'-')}</td>`;
                        html += `<td>${escapeHtml(c.usn||'-')}</td>`;
                        // Profile button column placeholder
                        html += `<td style="width:120px"><div id="profile_col_${idx}"></div></td>`;
                        // Resume column
                        html += `<td style="width:120px"><div id="resume_col_${idx}"></div></td>`;
                        // ID column
                        html += `<td style="width:120px"><div id="id_col_${idx}"></div></td>`;
                        // Project column
                        html += `<td style="width:120px"><div id="project_col_${idx}"></div></td>`;
                        // Actions (Accept / Reject)
                        html += `<td style="width:160px"><div id="actions_col_${idx}"></div></td>`;
                        html += `</tr>`;
                    });
                    html += '</tbody></table>';
                    cnt.innerHTML = html;
                    console.log('‚úÖ Table HTML inserted (compact)');

                    // Attach buttons into each column
                    data.data.forEach((c, idx) => {
                        // Profile button
                        const pDiv = document.getElementById(`profile_col_${idx}`);
                        if (pDiv) {
                            const btn = document.createElement('button');
                            btn.className = 'file-btn';
                            btn.style.background = '#28a745';
                            btn.textContent = 'View Profile';
                            btn.onclick = () => viewProfile(c.user_id || c.application_id || c.id);
                            pDiv.appendChild(btn);
                        }

                        // Resume
                        const rDiv = document.getElementById(`resume_col_${idx}`);
                        if (rDiv) {
                            if (c.resume_content) {
                                const vBtn = document.createElement('button');
                                vBtn.className = 'file-btn';
                                vBtn.textContent = 'View Resume';
                                vBtn.onclick = () => viewFile(c.resume_name||'Resume', c.resume_content, 'r');
                                rDiv.appendChild(vBtn);
                            } else {
                                rDiv.innerHTML = '<span style="color:#777">-</span>';
                            }
                        }

                        // ID
                        const idDiv = document.getElementById(`id_col_${idx}`);
                        if (idDiv) {
                            if (c.id_proof_content) {
                                const vBtn = document.createElement('button');
                                vBtn.className = 'file-btn';
                                vBtn.textContent = 'View ID';
                                vBtn.onclick = () => viewFile(c.id_proof_name||'ID', c.id_proof_content, 'i');
                                idDiv.appendChild(vBtn);
                            } else {
                                idDiv.innerHTML = '<span style="color:#777">-</span>';
                            }
                        }

                        // Project
                        const pjtDiv = document.getElementById(`project_col_${idx}`);
                        if (pjtDiv) {
                            if (c.project_document_content) {
                                const vBtn = document.createElement('button');
                                vBtn.className = 'file-btn';
                                vBtn.textContent = 'View Project';
                                vBtn.onclick = () => viewFile(c.project_document_name||'Project', c.project_document_content, 'p');
                                pjtDiv.appendChild(vBtn);
                            } else {
                                pjtDiv.innerHTML = '<span style="color:#777">-</span>';
                            }
                        }

                        // Actions: Accept / Reject
                        const aDiv = document.getElementById(`actions_col_${idx}`);
                        if (aDiv) {
                            const accept = document.createElement('button');
                            accept.className = 'file-btn';
                            accept.style.background = '#007bff';
                            accept.textContent = 'Accept';
                            accept.onclick = () => { if (confirm('Accept this candidate?')) adminAccept(c.user_id || c.application_id || c.id); };
                            aDiv.appendChild(accept);

                            const rej = document.createElement('button');
                            rej.className = 'file-btn';
                            rej.style.background = '#dc3545';
                            rej.textContent = 'Reject';
                            rej.onclick = () => { if (confirm('Reject this candidate? This will delete their data.')) adminReject(c.user_id || c.application_id || c.id); };
                            aDiv.appendChild(rej);
                        }
                    });
                    
                    document.getElementById('approved-count').textContent = data.data.length;
                    console.log('‚úÖ Table rendered with', data.data.length, 'rows');
                } else {
                    console.log('‚ö†Ô∏è No data or empty array');
                    cnt.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No approved candidates yet</p></div>';
                    document.getElementById('approved-count').textContent = '0';
                }
            } catch (e) {
                console.error('‚ùå Error:', e);
                document.getElementById('approvedCandidatesContainer').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error: ${escapeHtml(e.message)}</p></div>`;
            }
        }
        
        async function viewProfile(id) {
            try {
                const modal = document.getElementById('profileModal');
                const body = document.getElementById('profileBody');
                document.getElementById('profileTitle').textContent = 'Candidate Profile';
                body.innerHTML = '<p>Loading...</p>';
                modal.classList.add('show');

                // Try fetching single-candidate API
                const r = await fetch(`/admin/api/get-approved-candidate/${id}`);
                if (!r.ok) throw new Error('Failed to fetch profile');
                const payload = await r.json();
                if (!payload.success) throw new Error(payload.error || 'Unknown error');
                const c = payload.data;

                const rows = [];
                const add = (k, v) => rows.push(`<tr><th style="text-align:left;padding:8px;color:#555;width:220px">${escapeHtml(k)}</th><td style="padding:8px">${escapeHtml(v||'-')}</td></tr>`);
                add('Name', c.name);
                add('USN', c.usn);
                add('Email', c.email);
                add('Phone', c.phone_number || c.phone);
                add('Year', c.year);
                add('Qualification', c.qualification);
                add('Branch', c.branch);
                add('College', c.college);
                add('Domain', c.domain);
                add('Mode of Interview', c.mode_of_interview);
                add('Application ID', c.application_id);
                add('User ID', c.user_id);

                // Show profile details without Close button in profile modal; file viewing handled from table buttons
                let html = `<div style="width:100%"><div style="overflow:auto"><table style="width:100%;border-collapse:collapse">${rows.join('')}</table></div></div>`;
                body.innerHTML = html;
            } catch (e) {
                document.getElementById('profileBody').innerHTML = `<div class="empty-state"><p>Error: ${escapeHtml(e.message)}</p></div>`;
            }
        }

        function closeProfileModal() { document.getElementById('profileModal').classList.remove('show'); }

        async function adminAccept(id) {
            try {
                const r = await fetch(`/accept/${id}`, { method: 'POST' });
                const j = await r.json();
                if (j.success) { alert('Accept email sent.'); loadApprovedCandidates(); }
                else alert('Accept failed: ' + (j.error || j.message || JSON.stringify(j)));
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function adminReject(id) {
            try {
                const r = await fetch(`/reject/${id}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({reason: 'Rejected by admin'}) });
                const j = await r.json();
                if (j.success) { alert('Rejected and removed.'); loadApprovedCandidates(); }
                else alert('Reject failed: ' + (j.error || j.message || JSON.stringify(j)));
            } catch (e) { alert('Error: ' + e.message); }
        }

        document.addEventListener('DOMContentLoaded', loadApprovedCandidates);
        setInterval(loadApprovedCandidates, 30000);
    </script>
</body>
</html>
