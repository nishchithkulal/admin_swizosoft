<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Approved Candidates - Swizosoft</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin-unified.css') }}"
    />
    <style>
      .file-preview-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 4px;
      }
      .file-preview-text {
        background: #f5f5f5;
        padding: 1.5rem;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        word-break: break-word;
        width: 100%;
      }
      #fileModal .modal-content.full-bleed {
        width: 100vw !important;
        height: 100vh !important;
        border-radius: 0 !important;
        max-width: none !important;
      }
      #fileModal .modal-header.full-bleed-header {
        padding: 1rem 1.25rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">
          <div class="logo-icon">üéì</div>
          <span>Swizosoft</span>
        </div>
        <div class="navbar-menu">
          <a href="{{ url_for('admin_dashboard') }}" class="nav-link"
            >Dashboard</a
          >
          <a href="{{ url_for('admin_selected') }}" class="nav-link"
            >Selected Candidates</a
          >
          <a
            href="{{ url_for('admin_approved_candidates') }}"
            class="nav-link active"
            >Approved Candidates</a
          >
          <a href="{{ url_for('admin_job_description') }}" class="nav-link"
            >Job Description</a
          >
          <a href="{{ url_for('admin_issue_certificate') }}" class="nav-link"
            >Issue Certificate</a
          >
          <a href="{{ url_for('admin_logout') }}" class="nav-link logout-link"
            >Logout</a
          >
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="page-header">
        <h1>Manage Applications</h1>
        <p>View and manage internship applicants</p>
      </div>

      <div class="section-header">
        <h2>Free Internship Applicants</h2>
        <span style="color: #666; font-size: 0.9rem"
          >Applications received:
          <span
            class="count-badge"
            id="approved-count"
            style="margin-left: 0.5rem"
            >0</span
          ></span
        >
      </div>

      <div id="approvedCandidatesContainer">
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>Loading approved candidates...</p>
        </div>
      </div>
    </div>

    <div id="fileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="fileTitle">File Viewer</h3>
          <button class="modal-close" onclick="closeFileModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="fileViewerContainer"></div>
        </div>
      </div>
    </div>

    <div id="profileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="profileTitle">Candidate Profile</h3>
          <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="profileBody" style="width: 100%; max-width: 1100px"></div>
        </div>
      </div>
    </div>

    <!-- Domain Change Modal -->
    <div id="domainChangeModal" class="modal">
      <div
        class="modal-content"
        style="width: 500px; height: auto; max-height: 400px"
      >
        <div class="modal-header">
          <h3>Change Domain?</h3>
          <button class="modal-close" onclick="closeDomainChangeModal()">
            ‚úï
          </button>
        </div>
        <div
          class="modal-body"
          style="
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 2rem;
          "
        >
          <p style="margin-bottom: 1rem; color: #333">
            Would you like to change the candidate's domain?
          </p>

          <div style="width: 100%; margin-bottom: 1.5rem">
            <label
              style="display: block; margin-bottom: 0.5rem; font-weight: 600"
              >Select New Domain:</label
            >
            <select
              id="domainSelect"
              style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 0.95rem;
              "
            >
              <option value="">-- Keep Current Domain --</option>
              <option value="FULL STACK DEVELOPER">Full Stack Developer</option>
              <option value="ARTIFICIAL INTELLIGENCE">
                Artificial Intelligence
              </option>
              <option value="DATA SCIENCE">Data Science</option>
              <option value="DATA ANALYSIS">Data Analysis</option>
              <option value="MACHINE LEARNING">Machine Learning</option>
              <option value="ANDROID APP DEVELOPMENT">
                Android App Development
              </option>
              <option value="SQL DEVELOPER">SQL Developer</option>
              <option value="HUMAN RESOURCE">Human Resource</option>
            </select>
          </div>

          <div
            style="
              display: flex;
              gap: 1rem;
              width: 100%;
              justify-content: flex-end;
            "
          >
            <button
              onclick="closeDomainChangeModal()"
              style="
                padding: 0.5rem 1rem;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              Cancel
            </button>
            <button
              onclick="confirmAcceptWithDomain()"
              style="
                padding: 0.5rem 1rem;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              Accept
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Internship Type Modal -->
    <div id="internshipTypeModal" class="modal">
      <div
        class="modal-content"
        style="width: 500px; height: auto; max-height: 400px"
      >
        <div class="modal-header">
          <h3>Select Internship Type</h3>
          <button class="modal-close" onclick="closeInternshipTypeModal()">
            ‚úï
          </button>
        </div>
        <div
          class="modal-body"
          style="
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 2rem;
          "
        >
          <p style="margin-bottom: 1rem; color: #333">
            Please select the internship type:
          </p>

          <div style="width: 100%; margin-bottom: 1.5rem">
            <label
              style="display: block; margin-bottom: 0.5rem; font-weight: 600"
              >Internship Type:</label
            >
            <select
              id="internshipTypeSelect"
              style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 0.95rem;
              "
            >
              <option value="">-- Select Type --</option>
              <option value="remote-based opportunity">
                Remote-based opportunity
              </option>
              <option value="hybrid-based opportunity">
                Hybrid-based opportunity
              </option>
              <option value="on-site based opportunity">
                On-site based opportunity
              </option>
            </select>
          </div>

          <div
            style="
              display: flex;
              gap: 1rem;
              width: 100%;
              justify-content: flex-end;
            "
          >
            <button
              onclick="closeInternshipTypeModal()"
              style="
                padding: 0.5rem 1rem;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              Cancel
            </button>
            <button
              onclick="confirmInternshipType()"
              style="
                padding: 0.5rem 1rem;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              Proceed
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Offer Letter Modal -->
    <div id="offerLetterModal" class="modal">
      <div
        class="modal-content"
        style="width: 90vw; height: 90vh; max-width: 1200px"
      >
        <div class="modal-header">
          <h3 id="offerLetterTitle">Offer Letter Preview</h3>
          <button class="modal-close" onclick="closeOfferLetterModal()">
            ‚úï
          </button>
        </div>
        <div
          class="modal-body"
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            id="offerLetterContainer"
            style="
              width: 100%;
              height: 100%;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
            "
          >
            <p>Loading offer letter...</p>
          </div>
          <div style="margin-top: 1rem; display: flex; gap: 1rem">
            <button
              id="confirmOfferBtn"
              onclick="confirmOfferLetter()"
              style="
                padding: 0.6rem 1.5rem;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                display: none;
              "
            >
              ‚úì Confirm & Send
            </button>
            <button
              onclick="closeOfferLetterModal()"
              style="
                padding: 0.6rem 1.5rem;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
              "
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function escapeHtml(t) {
        return String(t || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[c])
        );
      }

      function formatDate(d) {
        if (!d) return "-";
        try {
          return String(
            new Date(d).toLocaleDateString("en-IN", {
              year: "numeric",
              month: "short",
              day: "numeric",
            })
          );
        } catch {
          return String(d);
        }
      }

      function viewFile(fname, b64, type) {
        const m = document.getElementById("fileModal");
        const c = document.getElementById("fileViewerContainer");
        document.getElementById("fileTitle").textContent =
          "View: " + escapeHtml(fname);
        // make modal full-bleed on open for a laptop-like viewer
        try {
          m.querySelector(".modal-content").classList.add("full-bleed");
        } catch (e) {}
        try {
          m.querySelector(".modal-header").classList.add("full-bleed-header");
        } catch (e) {}
        try {
          const ext = fname.split(".").pop().toLowerCase();
          // Make embedded viewer wider for laptop screens by using viewport-relative widths
          if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
            c.innerHTML = `<div style="display:flex;justify-content:center;width:100%"><img src="data:image/;base64,${b64}" class="file-preview-img" alt="${escapeHtml(
              fname
            )}" style="max-width:100vw;max-height:calc(100vh - 72px);border-radius:0;"></div>`;
          } else if (ext === "pdf") {
            // Full-bleed iframe for laptop screens
            c.innerHTML = `<div style="width:100%;height:100%"><iframe src="data:application/pdf;base64,${b64}" style="width:100vw;height:calc(100vh - 72px);border:none;"></iframe></div>`;
          } else {
            try {
              const t = new TextDecoder("utf-8").decode(
                new Uint8Array(
                  atob(b64)
                    .split("")
                    .map((x) => x.charCodeAt(0))
                )
              );
              c.innerHTML = `<div style="display:flex;justify-content:center;width:100%"><pre class="file-preview-text" style="max-width:100vw">${escapeHtml(
                t.substring(0, 10000)
              )}</pre></div>`;
            } catch {
              c.innerHTML =
                '<div class="file-preview-text">Binary file - cannot preview</div>';
            }
          }
        } catch (e) {
          c.innerHTML = `<div class="file-preview-text">Error: ${escapeHtml(
            e.message
          )}</div>`;
        }
        m.classList.add("show");
      }

      function downloadFile(fname, b64) {
        try {
          const l = document.createElement("a");
          l.href = `data:application/octet-stream;base64,${b64}`;
          l.download = fname;
          document.body.appendChild(l);
          l.click();
          document.body.removeChild(l);
        } catch (e) {
          alert("Error: " + e.message);
        }
      }

      function closeFileModal() {
        document.getElementById("fileModal").classList.remove("show");
      }

      window.onclick = (e) => {
        if (e.target === document.getElementById("fileModal")) closeFileModal();
        if (e.target === document.getElementById("profileModal"))
          closeProfileModal();
      };

      async function loadApprovedCandidates() {
        console.log("üì° Starting load...");
        try {
          const r = await fetch("/admin/api/get-approved-candidates");
          console.log("‚úÖ Fetch response:", r.status);
          const ct = (r.headers.get("content-type") || "").toLowerCase();
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          if (!ct.includes("application/json"))
            throw new Error("Non-JSON response");
          const data = await r.json();
          console.log("‚úÖ Data received:", data.data?.length, "rows");
          const cnt = document.getElementById("approvedCandidatesContainer");

          if (data.success && data.data && data.data.length > 0) {
            console.log("üìä Building compact table...");
            let html =
              '<table class="candidates-table"><thead><tr><th>Name</th><th>USN</th><th>Mode of Interview</th><th>Slot Date</th><th>Slot Time</th><th>View ID Proof</th><th>View Resume</th><th>View Project</th><th>View Profile</th><th>Action</th></tr></thead><tbody>';
            data.data.forEach((c, idx) => {
              html += `<tr>`;
              html += `<td>${escapeHtml(c.name || "-")}</td>`;
              html += `<td>${escapeHtml(c.usn || "-")}</td>`;
              // Mode of Interview column
              html += `<td>${escapeHtml(c.mode_of_interview || "-")}</td>`;
              // Slot Date column
              html += `<td>${formatDate(c.slot_date) || "-"}</td>`;
              // Slot Time column
              html += `<td>${escapeHtml(c.slot_time || "-")}</td>`;
              // resume_score removed per request
              // ID Proof button column placeholder
              html += `<td style="width:120px"><div id="id_col_${idx}"></div></td>`;
              // Resume column
              html += `<td style="width:120px"><div id="resume_col_${idx}"></div></td>`;
              // Project column
              html += `<td style="width:120px"><div id="project_col_${idx}"></div></td>`;
              // View Profile column
              html += `<td style="width:140px"><div id="profile_col_${idx}"></div></td>`;
              // Actions (Accept, Reject)
              html += `<td style="min-width:180px"><div id="actions_col_${idx}" style="display:flex;flex-wrap:nowrap;gap:0.5rem;"></div></td>`;
              html += `</tr>`;
            });
            html += "</tbody></table>";
            cnt.innerHTML = html;
            console.log("‚úÖ Table HTML inserted (compact)");

            // Attach buttons into each column
            data.data.forEach((c, idx) => {
              // ID Proof
              const idDiv = document.getElementById(`id_col_${idx}`);
              if (idDiv) {
                if (c.id_proof_content) {
                  const vBtn = document.createElement("button");
                  vBtn.className = "action-btn view-btn";
                  vBtn.textContent = "View ID Proof";
                  vBtn.onclick = () =>
                    viewFile(c.id_proof_name || "ID", c.id_proof_content, "i");
                  idDiv.appendChild(vBtn);
                } else {
                  idDiv.innerHTML = '<span style="color:#777">-</span>';
                }
              }

              // Resume
              const rDiv = document.getElementById(`resume_col_${idx}`);
              if (rDiv) {
                if (c.resume_content) {
                  const vBtn = document.createElement("button");
                  vBtn.className = "action-btn view-btn";
                  vBtn.textContent = "View Resume";
                  vBtn.onclick = () =>
                    viewFile(c.resume_name || "Resume", c.resume_content, "r");
                  rDiv.appendChild(vBtn);
                } else {
                  rDiv.innerHTML = '<span style="color:#777">-</span>';
                }
              }

              // Project
              const pjtDiv = document.getElementById(`project_col_${idx}`);
              if (pjtDiv) {
                if (c.project_document_content) {
                  const vBtn = document.createElement("button");
                  vBtn.className = "action-btn view-btn";
                  vBtn.textContent = "View Project";
                  vBtn.onclick = () =>
                    viewFile(
                      c.project_document_name || "Project",
                      c.project_document_content,
                      "p"
                    );
                  pjtDiv.appendChild(vBtn);
                } else {
                  pjtDiv.innerHTML = '<span style="color:#777">-</span>';
                }
              }

              // View Profile button in its own column
              const profileDiv = document.getElementById(`profile_col_${idx}`);
              if (profileDiv) {
                const viewProfile = document.createElement("button");
                viewProfile.className = "action-btn view-btn";
                viewProfile.textContent = "View Profile";
                viewProfile.onclick = () =>
                  viewProfileFn(c.user_id || c.application_id || c.id);
                profileDiv.appendChild(viewProfile);
              }
              // Actions: Accept, Reject
              const aDiv = document.getElementById(`actions_col_${idx}`);
              if (aDiv) {
                const accept = document.createElement("button");
                accept.className = "action-btn accept-btn";
                accept.textContent = "‚úì";
                accept.title = "Accept";
                accept.onclick = () => {
                  // Store current candidate ID and data for domain change modal
                  window.currentAcceptCandidate = {
                    id: c.user_id || c.application_id || c.id,
                    name: c.name,
                    currentDomain: c.domain,
                  };
                  document
                    .getElementById("domainChangeModal")
                    .classList.add("show");
                };
                aDiv.appendChild(accept);

                const rej = document.createElement("button");
                rej.className = "action-btn reject-btn";
                rej.textContent = "‚úï";
                rej.title = "Reject";
                rej.onclick = () => {
                  if (
                    confirm(
                      "Reject this candidate? This will delete their data."
                    )
                  )
                    adminReject(c.user_id || c.application_id || c.id);
                };
                aDiv.appendChild(rej);
              }
            });

            document.getElementById("approved-count").textContent =
              data.data.length;
            console.log("‚úÖ Table rendered with", data.data.length, "rows");
          } else {
            console.log("‚ö†Ô∏è No data or empty array");
            cnt.innerHTML =
              '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No approved candidates yet</p></div>';
            document.getElementById("approved-count").textContent = "0";
          }
        } catch (e) {
          console.error("‚ùå Error:", e);
          document.getElementById(
            "approvedCandidatesContainer"
          ).innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error: ${escapeHtml(
            e.message
          )}</p></div>`;
        }
      }

      function viewProfileFn(id) {
        viewProfile(id);
      }
      async function viewProfile(id) {
        try {
          const modal = document.getElementById("profileModal");
          const body = document.getElementById("profileBody");
          document.getElementById("profileTitle").textContent =
            "Candidate Profile";
          body.innerHTML = "<p>Loading...</p>";
          modal.classList.add("show");

          // Try fetching single-candidate API
          const r = await fetch(`/admin/api/get-approved-candidate/${id}`);
          if (!r.ok) throw new Error("Failed to fetch profile");
          const payload = await r.json();
          if (!payload.success)
            throw new Error(payload.error || "Unknown error");
          const c = payload.data;

          const rows = [];
          const add = (k, v) =>
            rows.push(
              `<tr><th style="text-align:left;padding:8px;color:#555;width:220px">${escapeHtml(
                k
              )}</th><td style="padding:8px">${escapeHtml(v || "-")}</td></tr>`
            );
          add("Name", c.name);
          add("USN", c.usn);
          add("Email", c.email);
          add("Phone", c.phone_number || c.phone);
          add("Year", c.year);
          add("Qualification", c.qualification);
          add("Branch", c.branch);
          add("College", c.college);
          add("Domain", c.domain);
          add("Mode of Interview", c.mode_of_interview);
          add("Slot Date", formatDate(c.slot_date));
          add("Slot Time", c.slot_time);
          add("Application ID", c.application_id);
          add("User ID", c.user_id);

          // Show profile details without Close button in profile modal; file viewing handled from table buttons
          let html = `<div style="width:100%"><div style="overflow:auto"><table style="width:100%;border-collapse:collapse">${rows.join(
            ""
          )}</table></div></div>`;
          body.innerHTML = html;
        } catch (e) {
          document.getElementById(
            "profileBody"
          ).innerHTML = `<div class="empty-state"><p>Error: ${escapeHtml(
            e.message
          )}</p></div>`;
        }
      }

      function closeProfileModal() {
        document.getElementById("profileModal").classList.remove("show");
      }

      async function adminAccept(id, newDomain = null) {
        try {
          // If domain change requested, update it first
          if (newDomain) {
            const updateResponse = await fetch(
              `/admin/api/update-approved-candidate-domain`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ candidate_id: id, domain: newDomain }),
              }
            );
            const updateResult = await updateResponse.json();
            if (!updateResult.success) {
              alert(
                "Failed to update domain: " +
                  (updateResult.error || "Unknown error")
              );
              return;
            }
          }

          // Fetch candidate data to check mode_of_internship
          const candidateResponse = await fetch(
            `/admin/api/get-approved-candidate/${id}`
          );
          const candidateData = await candidateResponse.json();

          if (!candidateData.success || !candidateData.data) {
            alert("Error: Could not fetch candidate data");
            return;
          }

          const candidate = candidateData.data;
          const modeOfInternship = candidate.mode_of_internship;

          // Check if mode_of_internship is set
          if (!modeOfInternship) {
            alert(
              "‚ö†Ô∏è This person has not yet registered for interview scheduling. Please ensure they complete the interview registration first to get their internship mode assigned."
            );
            return;
          }

          // Auto-select internship type based on mode_of_internship
          window.pendingCandidateId = id;
          window.autoSelectedInternshipType = modeOfInternship;

          // Directly proceed to accept without showing modal
          await confirmInternshipType(true);
        } catch (e) {
          alert("Error: " + e.message);
        }
      }

      function closeInternshipTypeModal() {
        document.getElementById("internshipTypeModal").classList.remove("show");
        window.pendingCandidateId = null;
        window.autoSelectedInternshipType = null;
      }

      async function confirmInternshipType(isAutoSelected = false) {
        let internshipType;

        if (isAutoSelected) {
          // Use the auto-selected type
          internshipType = window.autoSelectedInternshipType;
        } else {
          // Get from dropdown
          internshipType = document.getElementById(
            "internshipTypeSelect"
          ).value;
        }

        const candidateId = window.pendingCandidateId;

        if (!internshipType) {
          alert("Please select an internship type");
          return;
        }

        if (!candidateId) {
          alert("Error: Candidate ID not found");
          return;
        }

        // Close the modal (only needed if not auto-selected)
        if (!isAutoSelected) {
          closeInternshipTypeModal();
        }

        // Accept the candidate with internship type
        try {
          const acceptResponse = await fetch(`/accept/${candidateId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ internship_type: internshipType }),
          });
          const acceptResult = await acceptResponse.json();
          if (acceptResult.success) {
            alert("Candidate accepted! Downloading offer letter...");

            // Get USN and download offer letter
            try {
              const candidateInfo = await fetch(
                `/admin/api/get-selected-candidate/${candidateId}`
              ).then((r) => r.json());

              if (candidateInfo.success && candidateInfo.data) {
                const usn = candidateInfo.data.usn;
                // Trigger download
                setTimeout(() => {
                  const link = document.createElement("a");
                  link.href = `/admin/api/generate-offer-letter/${usn}`;
                  link.click();
                }, 300);
              }
            } catch (e) {
              console.error("Error downloading offer letter:", e);
            }

            loadApprovedCandidates();
          } else {
            alert(
              "Accept failed: " +
                (acceptResult.error ||
                  acceptResult.message ||
                  JSON.stringify(acceptResult))
            );
          }
        } catch (e) {
          alert("Error: " + e.message);
        }
      }

      function downloadOfferLetter(candidateId) {
        // Create a form to download the offer letter
        try {
          // First, let's try to get the USN from the candidate data
          // We'll query the API to get the candidate info
          fetch(`/admin/api/get-selected-candidate/${candidateId}`)
            .then((r) => r.json())
            .then((data) => {
              if (data.success && data.data) {
                const usn = data.data.usn;
                if (usn) {
                  // Create download link
                  const link = document.createElement("a");
                  link.href = `/admin/api/generate-offer-letter/${usn}`;
                  link.download = "";
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  alert("Offer letter downloaded successfully!");
                }
              }
            })
            .catch((e) => {
              console.error("Error fetching candidate:", e);
              alert(
                "Offer letter was generated. Check the Generated folder in offer-letter-generator."
              );
            });
        } catch (e) {
          console.error("Error downloading offer letter:", e);
          alert("Offer letter was generated. Check the Generated folder.");
        }
      }

      function closeDomainChangeModal() {
        document.getElementById("domainChangeModal").classList.remove("show");
        window.currentAcceptCandidate = null;
      }

      async function confirmAcceptWithDomain() {
        const selectedDomain = document.getElementById("domainSelect").value;
        const candidate = window.currentAcceptCandidate;

        if (!candidate) {
          alert("Error: Candidate data not found");
          return;
        }

        // Close the domain modal
        closeDomainChangeModal();

        // Now generate offer letter with the selected/kept domain
        await generateAndShowOfferLetter(
          candidate,
          selectedDomain || candidate.currentDomain
        );
      }

      // Store offer letter data for confirmation
      let currentOfferLetterData = null;

      async function generateAndShowOfferLetter(candidate, finalDomain) {
        try {
          console.log(
            "üîÑ Generating offer letter for:",
            candidate.name,
            "Domain:",
            finalDomain
          );

          // Show loading state
          showOfferLetterModal();
          document.getElementById("offerLetterContainer").innerHTML =
            "<p>Generating offer letter...</p>";
          document.getElementById("confirmOfferBtn").style.display = "none";

          // Get candidate details from the approved_candidates API
          const profileResponse = await fetch(
            `/admin/api/get-approved-candidate/${candidate.id}`
          );
          if (!profileResponse.ok) {
            throw new Error("Could not fetch candidate details");
          }

          const profileData = await profileResponse.json();
          if (!profileData.success || !profileData.data) {
            throw new Error("Candidate data not found");
          }

          const candidateData = profileData.data;

          // Call the new generate offer letter endpoint
          const generateResponse = await fetch(
            "/admin/api/generate-offer-letter-preview",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                candidate_id: candidate.id,
                source: "approved",
                name: candidateData.name,
                usn: candidateData.usn,
                college: candidateData.college,
                email: candidateData.email,
                domain: finalDomain,
                mode_of_internship: "free",
                internship_type: "free",
                duration: "1 month", // Default for free internship
              }),
            }
          );

          if (!generateResponse.ok) {
            const errorData = await generateResponse.json();
            throw new Error(
              errorData.error || "Failed to generate offer letter"
            );
          }

          const generateData = await generateResponse.json();
          if (!generateData.success) {
            throw new Error(
              generateData.error || "Offer letter generation failed"
            );
          }

          // Store for confirmation
          currentOfferLetterData = {
            candidate_id: candidate.id,
            source: "approved",
            name: candidateData.name,
            usn: candidateData.usn,
            email: candidateData.email,
            college: candidateData.college,
            domain: finalDomain,
            mode_of_internship: "free",
            internship_type: "free",
            duration: 1,
            pdf_b64: generateData.pdf_data,
            reference_number: generateData.reference_number,
          };

          // Display the PDF
          document.getElementById(
            "offerLetterTitle"
          ).textContent = `Offer Letter - ${generateData.reference_number}`;
          const container = document.getElementById("offerLetterContainer");
          const iframe = document.createElement("iframe");
          iframe.src = `data:application/pdf;base64,${generateData.pdf_data}`;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.style.borderRadius = "4px";

          container.innerHTML = "";
          container.appendChild(iframe);

          // Show confirm button
          document.getElementById("confirmOfferBtn").style.display = "block";

          console.log("‚úì Offer letter displayed, waiting for confirmation");
        } catch (error) {
          console.error("Error generating offer letter:", error);
          document.getElementById("offerLetterContainer").innerHTML = `
            <div style="color: #d32f2f; padding: 2rem; text-align: center;">
              <p>‚ùå Error: ${escapeHtml(error.message)}</p>
              <p style="font-size: 0.9rem; margin-top: 1rem; color: #666;">Please try again.</p>
            </div>
          `;
          document.getElementById("confirmOfferBtn").style.display = "none";
        }
      }

      function showOfferLetterModal() {
        document.getElementById("offerLetterModal").classList.add("show");
      }

      function closeOfferLetterModal() {
        document.getElementById("offerLetterModal").classList.remove("show");
      }

      async function confirmOfferLetter() {
        if (!currentOfferLetterData) {
          alert("No offer letter data available");
          return;
        }

        try {
          console.log("‚úì Processing offer letter workflow...");
          closeOfferLetterModal();

          const candidateData = currentOfferLetterData;
          const emailData = {
            email: candidateData.email,
            name: candidateData.name,
            pdf_b64: candidateData.pdf_b64,
            reference_number: candidateData.reference_number
          };

          const transferData = {
            usn: candidateData.usn,
            candidate_id: candidateData.candidate_id,
            name: candidateData.name,
            email: candidateData.email,
            domain: candidateData.domain,
            college: candidateData.college,
            duration_months: candidateData.duration,
            pdf_b64: candidateData.pdf_b64,
            reference_number: candidateData.reference_number,
            mode_of_internship: candidateData.mode_of_internship,
            internship_type: candidateData.internship_type
          };

          let emailStatus = { success: false, message: "Not attempted" };
          let transferStatus = { success: false, message: "Not attempted" };

          // Step 1: Send email (independent - errors here should not block data transfer)
          console.log("üìß Step 1: Sending offer letter email...");
          try {
            const emailResponse = await fetch(
              "/admin/api/send-offer-email",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(emailData),
              }
            );

            if (emailResponse.ok) {
              emailStatus = await emailResponse.json();
              console.log("‚úì Email step completed:", emailStatus);
            } else {
              const errorData = await emailResponse.json();
              emailStatus = {
                success: false,
                message: errorData.error || "Email send failed"
              };
              console.warn("‚ö†Ô∏è Email send returned error status:", errorData);
            }
          } catch (emailError) {
            emailStatus = {
              success: false,
              message: `Email error: ${emailError.message}`
            };
            console.warn("‚ö†Ô∏è Email send threw exception:", emailError);
          }

          // Step 2: Transfer data to Selected (independent - should work even if email fails)
          console.log("üì¶ Step 2: Transferring candidate to Selected table...");
          try {
            const transferResponse = await fetch(
              "/admin/api/transfer-to-selected",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(transferData),
              }
            );

            if (!transferResponse.ok) {
              const errorData = await transferResponse.json();
              throw new Error(
                errorData.error || "Failed to transfer candidate"
              );
            }

            transferStatus = await transferResponse.json();
            console.log("‚úì Transfer step completed:", transferStatus);

            if (!transferStatus.success) {
              throw new Error(transferStatus.error || "Transfer failed");
            }
          } catch (transferError) {
            transferStatus = {
              success: false,
              message: `Transfer error: ${transferError.message}`
            };
            console.error("‚ùå Transfer error:", transferError);
            throw transferError;  // Transfer is critical - fail if it doesn't work
          }

          // Step 3: Show summary to user
          console.log("‚úì Workflow complete!");

          let successMessage = "‚úì Success! ";
          let warningMessages = [];

          if (transferStatus.success) {
            successMessage += `Candidate ${candidateData.name} moved to Selected (ID: ${transferStatus.selected_candidate_id}). `;
          }

          if (!emailStatus.success) {
            warningMessages.push(`‚ö†Ô∏è Email: ${emailStatus.message}`);
          } else {
            successMessage += "Offer letter email sent. ";
          }

          if (warningMessages.length > 0) {
            alert(successMessage + "\n\n" + warningMessages.join("\n"));
          } else {
            alert(successMessage);
          }

          // Reload the tables
          loadApprovedCandidates();
          if (typeof loadSelectedCandidates === "function") {
            loadSelectedCandidates();
          }

          currentOfferLetterData = null;
        } catch (error) {
          console.error("Error in workflow:", error);
          alert("‚ùå Critical Error: " + error.message);
        }
      }

      async function adminReject(id) {
        try {
          const r = await fetch(`/reject/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reason: "Rejected by admin" }),
          });
          const j = await r.json();
          if (j.success) {
            alert("Rejected and removed.");
            loadApprovedCandidates();
          } else
            alert(
              "Reject failed: " + (j.error || j.message || JSON.stringify(j))
            );
        } catch (e) {
          alert("Error: " + e.message);
        }
      }

      // Certificate Generation Functions
      let currentCertificateData = null;

      async function issueCertificate(candidateId) {
        try {
          // Show certificate modal with loading state
          showCertificateModal();
          const container = document.getElementById("certificateContainer");
          container.innerHTML = "<p>Generating certificate...</p>";
          document.getElementById("downloadCertBtn").style.display = "none";

          // Call the backend API to generate certificate
          const response = await fetch(
            `/admin/api/generate-certificate/${candidateId}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || "Failed to generate certificate");
          }

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || "Certificate generation failed");
          }

          // Store certificate data for download
          currentCertificateData = {
            pdfData: data.pdf_data,
            filename: data.filename,
            certificateId: data.certificate_id,
          };

          // Display the PDF in the modal
          displayCertificate(data.pdf_data, data.certificate_id);
        } catch (error) {
          console.error("Error:", error);
          const container = document.getElementById("certificateContainer");
          container.innerHTML = `<div style="color: #d32f2f; padding: 2rem; text-align: center;">
            <p>‚ùå Error: ${error.message}</p>
            <p style="font-size: 0.9rem; margin-top: 1rem; color: #666;">Please try again.</p>
          </div>`;
          document.getElementById("downloadCertBtn").style.display = "none";
        }
      }

      function displayCertificate(base64Data, certificateId) {
        const container = document.getElementById("certificateContainer");

        // Update title with certificate ID
        document.getElementById(
          "certificateTitle"
        ).textContent = `Certificate - ${certificateId}`;

        // Use iframe to display PDF from base64
        const iframe = document.createElement("iframe");
        iframe.src = `data:application/pdf;base64,${base64Data}`;
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "none";
        iframe.style.borderRadius = "4px";

        container.innerHTML = "";
        container.appendChild(iframe);

        // Show download button
        document.getElementById("downloadCertBtn").style.display = "block";
      }

      function showCertificateModal() {
        document.getElementById("certificateModal").classList.add("show");
      }

      function closeCertificateModal() {
        document.getElementById("certificateModal").classList.remove("show");
        currentCertificateData = null;
      }

      function downloadCertificate() {
        if (!currentCertificateData) {
          alert("No certificate data available");
          return;
        }

        try {
          // Create blob from base64 data
          const binaryString = atob(currentCertificateData.pdfData);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: "application/pdf" });

          // Create download link and trigger
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = currentCertificateData.filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error("Download error:", error);
          alert("Failed to download certificate: " + error.message);
        }
      }

      document.addEventListener("DOMContentLoaded", loadApprovedCandidates);
      setInterval(loadApprovedCandidates, 30000);
    </script>
  </body>
</html>
