<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Issue Certificate - Swizosoft</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin-unified.css') }}"
    />
    <style>
      /* Page-specific styles for admin_issue_certificate */
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">
          <div class="logo-icon">üéì</div>
          <h1>Swizosoft</h1>
        </div>
        <div class="navbar-menu">
          <a href="{{ url_for('admin_dashboard') }}" class="nav-link"
            >Dashboard</a
          >
          <a href="{{ url_for('admin_selected') }}" class="nav-link"
            >Selected Candidates</a
          >
          <a href="{{ url_for('admin_approved_candidates') }}" class="nav-link"
            >Approved Candidates</a
          >
          <a href="{{ url_for('admin_job_description') }}" class="nav-link"
            >Job Description</a
          >
          <a
            href="{{ url_for('admin_issue_certificate') }}"
            class="nav-link active"
            >Issue Certificate</a
          >
          <a href="{{ url_for('admin_logout') }}" class="nav-link logout-link"
            >Logout</a
          >
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="page-header">
        <h1>Issue Certificate</h1>
        <p>Issue certificates to completed internship candidates</p>
      </div>

      <div class="section-header">
        <h2>Completed Candidates</h2>
        <span style="color: #666; font-size: 0.9rem"
          >Total candidates:
          <span
            class="count-badge"
            id="candidate-count"
            style="margin-left: 0.5rem"
            >0</span
          ></span
        >
      </div>

      <div class="table-wrapper">
        <div class="table-responsive">
          <table id="certificateTable" class="candidates-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Candidate ID</th>
                <th>USN</th>
                <th>Roles</th>
                <th>Project Title</th>
                <th>Project Report</th>
                <th>Project Description</th>
                <th>Profile</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="certificateTableBody">
              <tr>
                <td colspan="8" style="text-align: center; padding: 2rem">
                  <div class="empty-state" style="padding: 1rem">
                    <div class="empty-state-icon">üìã</div>
                    <p>Loading candidates...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="profileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="profileTitle">Candidate Profile</h3>
          <button class="modal-close" onclick="closeProfile()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="profileBody" style="width: 100%; max-width: 1100px"></div>
        </div>
      </div>
    </div>

    <script>
      function formatDate(dateStr) {
        if (!dateStr) return "-";
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString("en-IN", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        } catch {
          return dateStr;
        }
      }

      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
      }

      async function loadCandidates() {
        try {
          // Use new endpoint for completed candidates
          const response = await fetch("/admin/api/get-completed-candidates");
          const data = await response.json();

          if (data.success && data.data && data.data.length > 0) {
            const tbody = document.getElementById("certificateTableBody");
            tbody.innerHTML = "";

            data.data.forEach((candidate) => {
              const row = document.createElement("tr");

              const nameTd = document.createElement("td");
              nameTd.textContent = candidate.name || "";

              const candidateIdTd = document.createElement("td");
              candidateIdTd.textContent = candidate.candidate_id || "-";
              candidateIdTd.style.fontWeight = "500";
              candidateIdTd.style.color = "#0066cc";

              const usnTd = document.createElement("td");
              usnTd.textContent = candidate.usn || "";

              const rolesTd = document.createElement("td");
              rolesTd.textContent = candidate.roles || "-";

              const projectTitleTd = document.createElement("td");
              projectTitleTd.textContent = candidate.project_title || "-";

              const projectReportTd = document.createElement("td");
              if (candidate.internship_project_content) {
                const viewProjectBtn = document.createElement("button");
                viewProjectBtn.textContent = "View Project";
                viewProjectBtn.className = "action-btn view-btn";
                viewProjectBtn.onclick = () =>
                  viewProjectPDF(
                    candidate.usn,
                    candidate.internship_project_content,
                    candidate.project_title || "Project Document"
                  );
                projectReportTd.appendChild(viewProjectBtn);
              } else {
                projectReportTd.textContent = "-";
              }

              const projectDescTd = document.createElement("td");
              projectDescTd.textContent = candidate.project_description || "-";
              projectDescTd.style.maxWidth = "250px";
              projectDescTd.style.overflow = "hidden";
              projectDescTd.style.textOverflow = "ellipsis";
              projectDescTd.style.whiteSpace = "nowrap";

              const profileTd = document.createElement("td");
              const profileBtn = document.createElement("button");
              profileBtn.textContent = "View Profile";
              profileBtn.className = "action-btn view-btn";
              profileBtn.onclick = () =>
                openProfile(
                  candidate.usn || candidate.application_id || candidate.user_id
                );
              profileTd.appendChild(profileBtn);

              const actionTd = document.createElement("td");
              const issueBtn = document.createElement("button");
              issueBtn.textContent = "Issue Certificate";
              issueBtn.className = "action-btn issue-btn";
              issueBtn.onclick = () => {
                // Pass a reliable numeric id: prefer user_id, then application_id, then candidate_id
                const cid =
                  candidate.user_id ||
                  candidate.application_id ||
                  candidate.candidate_id ||
                  candidate.id;
                console.log(
                  "Issuing certificate for candidate",
                  cid,
                  candidate.name
                );
                issueCertificate(
                  candidate.usn,
                  candidate.name,
                  cid,
                  candidate.domain
                );
              };
              actionTd.appendChild(issueBtn);

              row.appendChild(nameTd);
              row.appendChild(candidateIdTd);
              row.appendChild(usnTd);
              row.appendChild(rolesTd);
              row.appendChild(projectTitleTd);
              row.appendChild(projectReportTd);
              row.appendChild(projectDescTd);
              row.appendChild(profileTd);
              row.appendChild(actionTd);
              tbody.appendChild(row);
            });

            document.getElementById("candidate-count").textContent =
              data.data.length;
          } else {
            const tbody = document.getElementById("certificateTableBody");
            tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem;">
                                <div class="empty-state" style="padding: 1rem;">
                                    <div class="empty-state-icon">üì≠</div>
                                    <p>No completed candidates found</p>
                                </div>
                            </td>
                        </tr>
                    `;
            document.getElementById("candidate-count").textContent = "0";
          }
        } catch (error) {
          console.error("Error loading candidates:", error);
          const tbody = document.getElementById("certificateTableBody");
          tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem;">
                            <div class="empty-state" style="padding: 1rem;">
                                <div class="empty-state-icon">‚ö†Ô∏è</div>
                                <p>Error loading candidates</p>
                            </div>
                        </td>
                    </tr>
                `;
        }
      }

      async function openProfile(id) {
        try {
          const modal = document.getElementById("profileModal");
          const body = document.getElementById("profileBody");
          body.innerHTML = "<p>Loading...</p>";
          modal.classList.add("show");

          const r = await fetch(
            `/admin/api/get-selected-candidate/${encodeURIComponent(id)}`
          );
          if (!r.ok) throw new Error("Failed to fetch profile");
          const payload = await r.json();
          if (!payload.success)
            throw new Error(payload.error || "Unknown error");
          const c = payload.data;

          const rows = [];
          const add = (k, v) =>
            rows.push(
              `<tr><th style="text-align:left;padding:8px;color:#555;width:220px">${escapeHtml(
                k
              )}</th><td style="padding:8px">${escapeHtml(v || "-")}</td></tr>`
            );

          add("Name", c.name);
          add("USN", c.usn);
          add("Email", c.email);
          add("Phone", c.phone || c.phone_number);
          add("Year", c.year);
          add("Qualification", c.qualification);
          add("Branch", c.branch);
          add("College", c.college);
          add("Domain", c.domain);
          add("Candidate ID", c.candidate_id);
          add("Approved Date", formatDate(c.approved_date));

          const html = `<div style="width:100%"><div style="overflow:auto"><table style="width:100%;border-collapse:collapse">${rows.join(
            ""
          )}</table></div></div>`;
          body.innerHTML = html;
        } catch (e) {
          document.getElementById(
            "profileBody"
          ).innerHTML = `<div class="empty-state"><p>Error: ${escapeHtml(
            e.message
          )}</p></div>`;
        }
      }

      function closeProfile() {
        // If a certificate was displayed, delete the generated file
        if (currentCertificateId) {
          deleteGeneratedFile(currentCertificateId);
        }
        document.getElementById("profileModal").classList.remove("show");
      }

      async function deleteGeneratedFile(certificateId) {
        // Delete the generated certificate file from server after viewing
        try {
          console.log(
            `Deleting generated file for certificate: ${certificateId}`
          );
          const resp = await fetch(
            `/admin/api/delete-generated-file/${encodeURIComponent(
              certificateId
            )}`,
            {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
            }
          );

          const data = await resp.json();
          if (data.success) {
            console.log(`‚úì File deleted: ${certificateId}`);
          } else {
            console.warn(
              `Could not delete file: ${data.message || "Unknown error"}`
            );
          }
        } catch (e) {
          console.warn(`Error deleting file: ${e.message}`);
          // Don't throw - file deletion is non-critical
        }
      }

      async function issueCertificate(usn, name, candidateId, usnCode) {
        try {
          // Show loading in profile modal
          const modal = document.getElementById("profileModal");
          const body = document.getElementById("profileBody");
          body.innerHTML = `<div style="padding:2rem;text-align:center;">Generating certificate for <strong>${escapeHtml(
            name
          )}</strong>...<br/><small>Please wait</small></div>`;
          modal.classList.add("show");

          const resp = await fetch(
            `/admin/api/generate-certificate/${candidateId}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            }
          );

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error || `Server returned ${resp.status}`);
          }

          const data = await resp.json();
          if (!data.success) {
            throw new Error(data.error || "Certificate generation failed");
          }

          // Use existing PDF viewer to show the returned base64 PDF
          // viewProjectPDF expects (usn, projectContent(base64), projectTitle)
          viewProjectPDF(
            usn,
            data.pdf_data,
            `Certificate - ${data.certificate_id}`
          );
        } catch (e) {
          // Show error inside the modal
          const modal = document.getElementById("profileModal");
          const body = document.getElementById("profileBody");
          body.innerHTML = `<div class="empty-state"><p style="color:#d32f2f;">Error generating certificate: ${escapeHtml(
            e.message || String(e)
          )}</p></div>`;
          modal.classList.add("show");
        }
      }

      // Holds the current certificate id when a certificate is displayed
      let currentCertificateId = null;

      function downloadCertificateById(certificateId) {
        if (!certificateId)
          return alert("No certificate available for download");
        // Trigger a navigation to the download endpoint which will prompt file download
        const url = `/admin/api/download-certificate/${encodeURIComponent(
          certificateId
        )}`;
        window.location.href = url;
      }

      function viewProjectPDF(usn, projectContent, projectTitle) {
        try {
          const modal = document.getElementById("profileModal");
          const body = document.getElementById("profileBody");
          // Create PDF viewer
          let pdfHtml = `
            <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
              <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display:flex; align-items:center; justify-content:space-between;">
                <h3 style="margin: 0;">${escapeHtml(projectTitle)}</h3>
                <div>
                  <button id="downloadPdfBtn" style="margin-left:8px;padding:0.4rem 0.6rem;background:#0066cc;color:#fff;border-radius:4px;border:none;cursor:pointer;">Download</button>
                </div>
              </div>
              <div style="flex: 1; display: flex; justify-content: center; align-items: center; background: #fff;">
          `;

          // Check if it's base64 encoded
          // Reset currentCertificateId
          currentCertificateId = null;

          if (projectContent && projectContent.length > 0) {
            // Assume it's base64 encoded
            const dataUrl = "data:application/pdf;base64," + projectContent;
            pdfHtml += `
              <iframe
                src="${dataUrl}"
                style="width: 100%; height: 100%; border: none; border-radius: 4px;"
                title="Project PDF"
              ></iframe>
            `;
            // If title contains certificate id in format 'Certificate - <ID>' set currentCertificateId
            if (projectTitle && projectTitle.startsWith("Certificate - ")) {
              currentCertificateId = projectTitle
                .split("Certificate - ")[1]
                .trim();
            }
          } else {
            pdfHtml += `<div style="text-align: center; color: #999;">No project document available</div>`;
          }

          pdfHtml += `
              </div>
            </div>
          `;

          body.innerHTML = pdfHtml;
          modal.classList.add("show");

          // Wire download button if present
          const dlBtn = document.getElementById("downloadPdfBtn");
          if (dlBtn) {
            dlBtn.onclick = () => {
              // Prefer explicit certificate id; if not available, try to parse from title
              let idToDownload = currentCertificateId;
              if (
                !idToDownload &&
                projectTitle &&
                projectTitle.startsWith("Certificate - ")
              ) {
                idToDownload = projectTitle.split("Certificate - ")[1].trim();
              }
              downloadCertificateById(idToDownload);
            };
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }
      window.onclick = (e) => {
        if (e.target === document.getElementById("profileModal"))
          closeProfile();
      };

      document.addEventListener("DOMContentLoaded", loadCandidates);
      setInterval(loadCandidates, 30000);
    </script>
  </body>
</html>
