<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Descriptions - Admin</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin-unified.css') }}"
    />
    <style>
      .jd-panel {
        max-width: 1100px;
        margin: 32px auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .domains-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }
      .domain-btn {
        background: #0066cc;
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.2s;
      }
      .domain-btn:hover {
        background: #0052a3;
      }
      .domain-btn.active {
        background: #0052a3;
        box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
      }
      .domain-btn.secondary {
        background: #f1f3f8;
        color: #333;
        border: 1px solid #e6e9f2;
      }
      .domain-btn.secondary:hover {
        background: #e8ecf5;
      }
      .jd-display {
        border: 1px solid #eee;
        padding: 16px;
        border-radius: 6px;
        min-height: 160px;
        background: #fafafa;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      #jd-text {
        min-height: 300px;
        resize: vertical;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 16px;
      }
      .action-buttons {
        margin-top: 12px;
        display: flex;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">
          <div class="logo-icon">ðŸŽ“</div>
          <h1>Swizosoft</h1>
        </div>
        <div class="navbar-menu">
          <a href="{{ url_for('admin_dashboard') }}" class="nav-link"
            >Dashboard</a
          >
          <a href="{{ url_for('admin_selected') }}" class="nav-link"
            >Selected Candidates</a
          >
          <a href="{{ url_for('admin_approved_candidates') }}" class="nav-link"
            >Approved Candidates</a
          >
          <a
            href="{{ url_for('admin_job_description') }}"
            class="nav-link active"
            >Job Description</a
          >
          <a href="{{ url_for('admin_issue_certificate') }}" class="nav-link"
            >Issue Certificate</a
          >
          <a href="{{ url_for('admin_logout') }}" class="nav-link logout-link"
            >Logout</a
          >
        </div>
      </div>
    </nav>

    <div class="dashboard-container">
      <div class="jd-panel">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
          "
        >
          <h3 style="margin: 0">Job Descriptions</h3>
          <button class="domain-btn secondary" onclick="openEditor(false)">
            + Add New
          </button>
        </div>

        <div class="domains-row" id="domainsRow">
          {% if rows %} {% for row in rows %}
          <button
            class="domain-btn"
            data-id="{{ row['id'] }}"
            data-domain="{{ row['domain'] or ''|e }}"
            data-desc="{{ row['description']|e }}"
            onclick="openViewer(this)"
          >
            {{ row['domain'] or ('General '+row['id']|string) }}
          </button>
          {% endfor %} {% else %}
          <div style="color: #666; padding: 8px">
            No job descriptions found. Click "Add New" to create one.
          </div>
          {% endif %}
        </div>

        <div>
          <h4 style="margin: 0 0 8px 0">Preview</h4>
          <div id="jdPreview" class="jd-display">
            Select a domain to view its job description.
          </div>
          <div class="action-buttons">
            <button
              id="editBtn"
              class="file-btn"
              style="display: none"
              onclick="openEditor(true)"
            >
              Edit
            </button>
            <button
              id="deleteBtn"
              class="file-btn"
              style="display: none; background: #ff6b6b"
              onclick="confirmDelete()"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for add/edit -->
    <div id="jdModal" class="modal" role="dialog">
      <div class="modal-card">
        <div class="modal-header">
          <strong id="modalTitle">Edit Job Description</strong>
          <button type="button" class="modal-close" onclick="closeModal()">
            Ã—
          </button>
        </div>
        <div class="modal-body">
          <form
            id="jdForm"
            method="post"
            action="{{ url_for('admin_job_description') }}"
          >
            <input type="hidden" name="action" id="formAction" value="save" />
            <input type="hidden" name="id" id="formId" />

            <div class="form-group">
              <label for="formDomain">Domain Name</label>
              <input
                type="text"
                id="formDomain"
                name="domain"
                placeholder="e.g., Full Stack Developer"
              />
            </div>

            <div class="form-group">
              <label for="jd-text">Job Description</label>
              <textarea
                id="jd-text"
                name="description"
                placeholder="Enter job description here..."
              ></textarea>
            </div>

            <div class="modal-actions">
              <button
                type="button"
                class="file-btn"
                onclick="submitForm('save')"
              >
                Save
              </button>
              <button
                type="button"
                class="file-btn"
                onclick="submitForm('add')"
              >
                Add
              </button>
              <button
                type="button"
                class="file-btn secondary"
                onclick="closeModal()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      var current = { id: null, domain: null, description: null };

      function openViewer(btn) {
        var el = btn instanceof Element ? btn : this;
        var id = el.getAttribute("data-id");
        var domain = el.getAttribute("data-domain") || "";
        var desc = el.getAttribute("data-desc") || "";

        current.id = id;
        current.domain = domain;
        current.description = desc;

        // Update preview
        document.getElementById("jdPreview").textContent =
          desc || "(No description)";

        // Show buttons
        document.getElementById("editBtn").style.display = "inline-block";
        document.getElementById("deleteBtn").style.display = "inline-block";

        // Update active button styling
        document
          .querySelectorAll(".domain-btn:not(.secondary)")
          .forEach((btn) => {
            btn.classList.remove("active");
          });
        el.classList.add("active");
      }

      function openEditor(fromViewer) {
        document.getElementById("jdModal").classList.add("show");

        if (fromViewer) {
          document.getElementById("modalTitle").textContent =
            "Edit Job Description";
          document.getElementById("formAction").value = "save";
          if (current.id) {
            document.getElementById("formId").value = current.id;
            document.getElementById("formDomain").value = current.domain || "";
            document.getElementById("jd-text").value =
              current.description || "";
          }
        } else {
          document.getElementById("modalTitle").textContent =
            "Add Job Description";
          document.getElementById("formAction").value = "add";
          document.getElementById("formId").value = "";
          document.getElementById("formDomain").value = "";
          document.getElementById("jd-text").value = "";
        }

        // Focus on domain input
        setTimeout(() => document.getElementById("formDomain").focus(), 100);
      }

      function closeModal() {
        document.getElementById("jdModal").classList.remove("show");
      }

      function submitForm(action) {
        var domain = document.getElementById("formDomain").value.trim();
        var description = document.getElementById("jd-text").value.trim();

        // Validation
        if (!domain && action === "add") {
          alert("Please enter a domain name");
          return;
        }

        if (!description) {
          alert("Please enter a job description");
          return;
        }

        document.getElementById("formAction").value = action;
        document.getElementById("jdForm").submit();
      }

      function confirmDelete() {
        if (!current.id && !current.domain) {
          alert("No domain selected");
          return;
        }

        if (
          !confirm("Delete this job description? This action cannot be undone.")
        ) {
          return;
        }

        // Create hidden form for delete
        var form = document.createElement("form");
        form.method = "post";
        form.action = '{{ url_for("admin_job_description") }}';

        var actionInput = document.createElement("input");
        actionInput.type = "hidden";
        actionInput.name = "action";
        actionInput.value = "delete";
        form.appendChild(actionInput);

        if (current.id) {
          var idInput = document.createElement("input");
          idInput.type = "hidden";
          idInput.name = "id";
          idInput.value = current.id;
          form.appendChild(idInput);
        } else if (current.domain) {
          var domainInput = document.createElement("input");
          domainInput.type = "hidden";
          domainInput.name = "domain";
          domainInput.value = current.domain;
          form.appendChild(domainInput);
        }

        document.body.appendChild(form);
        form.submit();
      }

      // Close modal when clicking outside of it
      document
        .getElementById("jdModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      // Allow Escape key to close modal
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeModal();
        }
      });
    </script>
  </body>
</html>
